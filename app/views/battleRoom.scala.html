@(username: String,key:String)

@main(username) {
<link rel="stylesheet" media="screen" href="@routes.Assets.at("stylesheets/battleRoom.css")">
<script src="@routes.Assets.at("javascripts/h5utils.js")" type="text/javascript"></script>
<script src="@routes.Assets.at("javascripts/MiscFuncs.js")" type="text/javascript"></script>
<script src="@routes.Assets.at("javascripts/battleship-bot.js")" type="text/javascript"></script>
<script src="@routes.Assets.at("javascripts/battleship-bot.min.js")" type="text/javascript"></script>
<script src="@routes.Assets.at("javascripts/data.js")" type="text/javascript"></script>
<script src="@routes.Assets.at("javascripts/popUpManager.js")" type="text/javascript"></script>

    <div class="page-header">
        <h1>Welcome to the Battle room <small>You are captain @username</small></h1>
    </div>
    
    <div id="onError" class="alert-message error">
        <p>
            <strong>Oops!</strong> <span></span>
        </p>
    </div>
    <div id="onChat" class="row onChat" >
        <div class="span10" id="My_board">
        </div>
        <div class="span10" id="board" style="display: none;">

        </div>
        <div class="span2">
            <h2>Players</h2>
            <ul id="members">
            </ul>
        </div>
        <div class="span4" id="shipyard">
            <!--<div id="dragAndDRop">
             <div id="ship1Div" draggable="true" class="draggableShip" ondragstart="dragIt('ship1Div',event);"  onclick="toggleDirection(this)" horizontal="true">
                <img id="ship1" src="@routes.Assets.at("images/aircraftCarrier.png")">
            </div>
            <div id="ship2Div" draggable="true" class="draggableShip" ondragstart="dragIt('ship2Div',event);"  onclick="toggleDirection(this)" horizontal="true">
                <img id="ship4" src="@routes.Assets.at("images/Ship.png")">
            </div>
            </div>  -->

        </div>
        <div id="buttom">
            <input id="readyButton" class="button blue main" onclick="ready()" value="Ready to play">
        </div>

        <div class="span4" id="main" style="display: none;">
            <div id="messages">
            </div>
            <textarea id="talk"></textarea>
        </div>
        <div><input type="checkbox" id="autoplayCheck" onClick=setAutoplay() /></div>



<div id='popup'></div>

</div>
    <script type="text/javascript" charset="utf-8">

      conn=new WsConnection("@routes.Application.battle(key,username).webSocketURL(request)",chatRecieve)
      var autoplay = false;



        function ready(){
                    bot = new BattleshipBot();
                    document.getElementById("board").style.display ="block";
                    document.getElementById("main").style.display ="block";
                    document.getElementById("shipyard").style.display ="none";
                    document.getElementById("buttom").style.display ="none";
                    $("#onChat").removeClass('onChat');


            readyToPlay()


        }

    function setAutoplay(){
        if(document.getElementById("autoplayCheck").checked==1){
               autoplay=true;
        }else{
            autoplay=false;
        }


    }

      function chatRecieve(event) {
          var data = JSON.parse(event.data)
          var letters = new Array("A","B","C","D","E","F","G","H","I","J");
          // Handle errors
          if(data.error) {
              conn.close()
              $("#onError span").text(data.error)
              $("#onError").show()
              return
          } else {
              $("#onChat").show()
          }


          // Create the message element
          var el = $('<div class="message"><span></span><p></p></div>')
          $("span", el).text(data.user+":")
          $("p", el).text(data.message)
          $(el).addClass(data.kind)

          if(data.user == "@username") $(el).addClass('me')
          $('#messages').append(el)

          // Update the members list
          $("#members").html('')
          $(data.members).each(function() {
              $("#members").append('<li>' + this + '</li>')
          })




          if(data.data){

              var json=JSON.parse(data.data)

      console.log(json);
      //+++++++++++++++++++++++++++++Strategy++++++++++++++++++++++++++++++++++++++//
        if(json.type=='strategy'){
      for(x=0;x < json.shipPositions.length;x++){

        if(json.orientation=="true"){
        $('#My_board_'+json.shipPositions[x]).addClass(json.shipName);

        div ='My_board_'+json.shipPositions[x];

        document.getElementById(div).style.backgroundPosition = -32*x+'px 0px';
         }else{

        $('#My_board_'+json.shipPositions[x]).addClass(json.shipName+'Vertical');

        div ='My_board_'+json.shipPositions[x];
        document.getElementById(div).style.backgroundPosition = '0px'+' '+-32*x+"px";

        }
        }
        }
        //++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++//
        //++++++++++++++++++++++++++++++++++++attack++++++++++++++++++++++++++++++++++++++++++++++//

        //si me atacaron
        if(json.board == "@username"){

                   if(json.state == 'sunk'){

        for(positions in json.shipPositions){
        $('#My_board_'+json.tile).removeClass('hit');
        $('#My_board_'+json.shipPositions[positions]).addClass(json.state);

         }
          if(autoplay){
              console.log("bot play!");
              var point = bot.suggest();
              var letterNumber =0;
              for(var k=0;k<letters.length;k++){
                  if(point.x.equals(k)){
                     letterNumber=k;
                     break;
                  }
              }
              console.log("HEY"+point);
              attack(letters[letterNumber]+point.y.toString());
          }else{
              console.log("nooooo")
          }
        } else{


        $('#My_board_'+json.tile).addClass(json.state);
                       if(autoplay){
                          console.log("bot play!");

                          var point = bot.suggest();
                           console.log("HEY"+point);
                          var letterNumber =0;
                          for(var k=0;k<letters.length;k++){
                              if(point.x==k){
                                 letterNumber=k;
                                 break;
                              }
                          }

                          attack(letters[letterNumber]+point.y.toString());
                      }else{
                          console.log("nooooo")
                      }
         }

        //si ataque yo
        }else {

            if(json.state=='win'){
                           popUp("@username","won");

                        }
                 console.log("tile: "+json.tile)
            var letterPos = json.tile;
        var letritas=letterPos.substr(0,1);

            var letterIndex = 0;
            for(var j=0;j<letters.length;j++) {
                if(letters[j]==letritas){
                    letterIndex=j;
                }
                break;
            }

        if(json.state == 'sunk'){

            bot.update(parseInt(json.tile.substring(1)),letterIndex+1,json.shipName);
            console.log("updating bot")

       for(positions in json.shipPositions){
        $('#My_board_'+json.tile).removeClass('hit');
        $('#'+json.shipPositions[positions]).addClass(json.state);

        }

        }else{
            console.log(letterIndex+1+" "+json.tile.substring(1)+" "+json.state)


            bot.update(parseInt(json.tile.substring(1)),letterIndex+1,json.state);
            console.log("updating bot")
        $('#'+json.tile).addClass(json.state);

        }

        }
          }
      }


      var handleReturnKey = function(e) {
          if(e.charCode == 13 || e.keyCode == 13) {
              e.preventDefault()
              conn.ws({send:{text: $("#talk").val()},beforeSend:function(){$("#talk").val('')}})
          }
      }
      $("#talk").keypress(handleReturnKey)

    </script>
}